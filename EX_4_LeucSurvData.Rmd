---
title: "Main"
output: html_document
---
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# upload packages 
library(spdep)

# Load the LeukSurv dataset

load("LeukSurv.rda")
head(LeukSurv)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Discretize wbc and tpi into 50 bins each

LeukSurv$wbc_disc <- as.numeric(cut(LeukSurv$wbc, breaks = 50))
LeukSurv$tpi_disc <- as.numeric(cut(LeukSurv$tpi, breaks = 50))

# Convert categorical variables to factors
LeukSurv$sex <- as.factor(LeukSurv$sex)
LeukSurv$district <- as.factor(LeukSurv$district)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Create district_id as a numeric factor for districts

library(ggplot2)


ggplot(LeukSurv, aes(x = xcoord, y = ycoord, color = factor(district))) +
  geom_point(size = 2, alpha = 0.8) +
  labs(
    title = "Spatial Nodes Colored by District",
    x = "xcoord", y = "ycoord", color = "District"
  ) +
  theme_minimal() +
  theme(legend.position = "right")


```
```{r}
library(dplyr)
library(spdep)
library(ggplot2)

# 1. Compute district centroids
district_centroids <- LeukSurv %>%
  group_by(district) %>%
  summarise(
    x = mean(xcoord),
    y = mean(ycoord)
  ) %>%
  ungroup()

# 2. Get coordinates matrix of centroids
coords_centroids <- as.matrix(district_centroids[, c("x", "y")])

# 3. k-nearest neighbors between districts (e.g. k = 3)
k <- 3
knn_districts <- knearneigh(coords_centroids, k = k)
nb_districts <- knn2nb(knn_districts)

# 4. Convert to edge list for ggplot
district_edges <- do.call(rbind, lapply(1:length(nb_districts), function(i) {
  if (length(nb_districts[[i]]) == 0) return(NULL)
  data.frame(
    from = district_centroids$district[i],
    to = district_centroids$district[nb_districts[[i]]],
    x = coords_centroids[i, 1],
    y = coords_centroids[i, 2],
    xend = coords_centroids[nb_districts[[i]], 1],
    yend = coords_centroids[nb_districts[[i]], 2]
  )
}))


```

```{r}
#let us evaluete the random effect of IGMRF of first orderÃ¹
library(INLA)
# Model A: Unscaled
formulaA <- inla.surv(time, cens) ~ sex + age +
  f(wbc_disc, model = "rw2", scale.model = FALSE) +
  f(tpi_disc, model = "rw2", scale.model = FALSE)

# Model B: Scaled
formulaB <- inla.surv(time, cens) ~ sex + age +
  f(wbc_disc, model = "rw2", scale.model = TRUE) +
  f(tpi_disc, model = "rw2", scale.model = TRUE)

# Model C: Scaled + rescaled hyperpriors
formulaC <- inla.surv(time, cens) ~ sex + age +
  f(wbc_disc, model = "rw2", scale.model = TRUE,
    hyper = list(prec = list(prior = "loggamma", param = c(1, 1.5e-9)))) +
  f(tpi_disc, model = "rw2", scale.model = TRUE,
    hyper = list(prec = list(prior = "loggamma", param = c(1, 4e-5))))

fitA <- inla(formulaA, data = LeukSurv, family = "coxph")
fitB <- inla(formulaB, data = LeukSurv, family = "coxph")
fitC <- inla(formulaC, data = LeukSurv, family = "coxph")


plot(fitA$summary.random$wbc_disc$mean, type = "l", col = "black", ylim = c(-0.5, 1),
     ylab = "Effect of WBC", xlab = "Index", main = "WBC Effect Comparison")
lines(fitB$summary.random$wbc_disc$mean, col = "red")
lines(fitC$summary.random$wbc_disc$mean, col = "blue")
legend("topright", legend = c("Unscaled", "Scaled", "Rescaled"),
       col = c("black", "red", "blue"), lty = 1)

plot(fitA$summary.random$tpi_disc$mean, type = "l", col = "black", ylim = c(-.4, .2),
     ylab = "Effect of TPI", xlab = "Index", main = "TPI Effect Comparison")
lines(fitB$summary.random$tpi_disc$mean, col = "red")
lines(fitC$summary.random$tpi_disc$mean, col = "blue")
legend("topright", legend = c("Unscaled", "Scaled", "Rescaled"),
       col = c("black", "red", "blue"), lty = 1)



```

