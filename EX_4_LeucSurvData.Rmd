---
title: "Main"
output: html_document
---
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# upload packages 
library(spdep)

# Load the LeukSurv dataset

load("LeukSurv.rda")
head(LeukSurv)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Discretize wbc and tpi into 50 bins each

LeukSurv$wbc_disc <- as.numeric(cut(LeukSurv$wbc, breaks = 50))
LeukSurv$tpi_disc <- as.numeric(cut(LeukSurv$tpi, breaks = 50))

# Convert categorical variables to factors
LeukSurv$sex <- as.factor(LeukSurv$sex)
LeukSurv$district <- as.factor(LeukSurv$district)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Create district_id as a numeric factor for districts

library(ggplot2)


ggplot(LeukSurv, aes(x = xcoord, y = ycoord, color = factor(district))) +
  geom_point(size = 2, alpha = 0.8) +
  labs(
    title = "Spatial Nodes Colored by District",
    x = "xcoord", y = "ycoord", color = "District"
  ) +
  theme_minimal() +
  theme(legend.position = "right")


```
```{r}
library(dplyr)
library(spdep)
library(ggplot2)
library(sf)

# 1. Compute district centroids
district_centroids <- LeukSurv %>%
  group_by(district) %>%
  summarise(
    x = mean(xcoord),
    y = mean(ycoord)
  ) %>%
  ungroup()

# 2. Convert centroids to matrix
coords_centroids <- as.matrix(district_centroids[, c("x", "y")])

# 3. k-nearest neighbors (e.g. k = 3)
k <- 3
knn_districts <- knearneigh(coords_centroids, k = k)
nb_districts <- knn2nb(knn_districts)

# 4. Function to build edge list
nb_lines <- function(nb_list, centroids_df) {
  edges <- do.call(rbind, lapply(1:length(nb_list), function(i) {
    neighbors <- nb_list[[i]]
    if (length(neighbors) == 0) return(NULL)
    do.call(rbind, lapply(neighbors, function(j) {
      data.frame(
        x = centroids_df[i, 1],
        y = centroids_df[i, 2],
        xend = centroids_df[j, 1],
        yend = centroids_df[j, 2],
        group = paste(i, j, sep = "-")
      )
    }))
  }))
  return(edges)
}

# 5. Create edges and point data
edges_df <- nb_lines(nb_districts, coords_centroids)
points_df <- as.data.frame(coords_centroids)
colnames(points_df) <- c("x", "y")

# 6. Plot with ggplot2
ggplot() +
  geom_segment(data = edges_df, aes(x = x, y = y, xend = xend, yend = yend, group = group),
               color = "gray60", linewidth = 0.6) +
  geom_point(data = points_df, aes(x = x, y = y), color = "blue", size = 3) +
  theme_minimal() +
  labs(title = "Spatial Neighborhood Structure (k-NN)",
       x = "Longitude", y = "Latitude")



```


```{r}


library(INLA)
library(dplyr)




LeukSurv$surv <- inla.surv(LeukSurv$time, LeukSurv$cens)

#----------------------------
# 3. Discretize Continuous Covariates into 50 Bins

#----------------------------
# 4. Define Hyperpriors (Gamma(1, b)) from SÃ¸rbye & Rue (2014)
#----------------------------
hyper_wbc     <- list(prec = list(prior = "gamma", param = c(1, 1.5e-9)))
hyper_tpi     <- list(prec = list(prior = "gamma", param = c(1, 4.0e-5)))
hyper_spatial <- list(prec = list(prior = "gamma", param = c(1, 6.1e-4)))

#----------------------------
# 5. Spatial Structure: Save Graph File
#----------------------------
# Ensure district_id is integer and 1-based
LeukSurv$district_id <- as.integer(as.factor(LeukSurv$district))

# Save spatial adjacency graph (must exist!)
nb2INLA("district.graph", nb_districts)

#----------------------------
# 6. Create Time Intervals for Piecewise Constant Baseline
#----------------------------
cuts <- seq(0, max(LeukSurv$time), length.out = 50)
LeukSurv$baseline <- as.integer(cut(LeukSurv$time, breaks = cuts, include.lowest = TRUE))

#----------------------------
# 7. Define Model Formula
#----------------------------
formula <- surv ~
  f(baseline, model = "rw1", constr = TRUE) +       # Piecewise baseline hazard
  sex + age +                                       # Fixed effects
  f(wbc_discrete, model = "rw2", hyper = hyper_wbc, constr = TRUE) +
  f(tpi_discrete, model = "rw2", hyper = hyper_tpi, constr = TRUE) +
  f(district_id, model = "besag", graph = "district.graph", hyper = hyper_spatial)

#----------------------------
# 8. Fit Model with INLA
#----------------------------
result <- inla(
  formula,
  data = LeukSurv,
  family = "coxph",
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE),
  control.predictor = list(compute = TRUE)
)


```


